name: Update RSS Feeds

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on push to main for testing
  push:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  transform-and-deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Transform RSS feed
        env:
          KILL_THE_NEWSLETTER_URL: ${{ secrets.KILL_THE_NEWSLETTER_URL }}
        run: |
          python transform.py --output feeds --base-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
      
      - name: Create index.html for feeds
        run: |
          # Generate the feed list from actual XML files
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          FEED_LIST=""
          for feed in feeds/*.xml; do
            if [ -f "$feed" ]; then
              filename=$(basename "$feed")
              showname=$(echo "$filename" | sed 's/.xml$//' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              FEED_LIST="${FEED_LIST}<li><a href=\"${filename}\">${showname}</a><br><small class=\"feed-url\">${BASE_URL}/${filename}</small></li>"
            fi
          done
          
          cat > feeds/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Dropout Newsletter RSS Feeds</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 40px auto;
                      padding: 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 {
                      color: #2563eb;
                      border-bottom: 3px solid #2563eb;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #4b5563;
                      margin-top: 30px;
                  }
                  ul {
                      list-style: none;
                      padding: 0;
                  }
                  li {
                      margin: 10px 0;
                      padding: 10px;
                      background: #f3f4f6;
                      border-radius: 5px;
                  }
                  a {
                      color: #2563eb;
                      text-decoration: none;
                      font-weight: 500;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .feed-url {
                      font-family: monospace;
                      font-size: 0.9em;
                      background: #e5e7eb;
                      padding: 2px 6px;
                      border-radius: 3px;
                  }
                  .info {
                      background: #dbeafe;
                      padding: 15px;
                      border-radius: 5px;
                      border-left: 4px solid #2563eb;
                      margin: 20px 0;
                  }
              </style>
          </head>
          <body>
              <h1>ðŸ“º Dropout Newsletter RSS Feeds</h1>
              
              <div class="info">
                  <p><strong>Welcome!</strong> These RSS feeds are automatically generated from the Dropout newsletter.</p>
                  <p>Subscribe to individual shows or the combined feed using your favorite RSS reader.</p>
              </div>
              
              <h2>Available Feeds</h2>
              <ul>
                  ${FEED_LIST}
              </ul>
              
              <h2>How to Use</h2>
              <ol>
                  <li>Copy the feed URL you want to subscribe to</li>
                  <li>Open your RSS reader (e.g., Feedly, NewsBlur, NetNewsWire)</li>
                  <li>Add the feed URL to your reader</li>
                  <li>Enjoy your Dropout content!</li>
              </ol>
          </body>
          </html>
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'feeds'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
