name: Update RSS Feeds

on:
  # Run every 6 hours (4 times per day - well within free tier limits)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on push to main for testing
  push:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  transform-and-deploy:
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Download previous feeds (if they exist)
        continue-on-error: true
        run: |
          # Try to download the current GitHub Pages deployment
          # This allows us to preserve feeds from the last successful run
          echo "Attempting to download previous feeds from GitHub Pages..."
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          
          # Create feeds directory if it doesn't exist
          mkdir -p feeds
          
          # Try to download the index page to get the list of feeds
          if wget -q "${PAGES_URL}/index.html" -O "/tmp/prev-index.html" 2>/dev/null; then
            # Extract feed filenames from the index.html
            grep -oP 'href="\K[^"]*\.xml' /tmp/prev-index.html 2>/dev/null | while read -r feed_file; do
              wget -q "${PAGES_URL}/${feed_file}" -O "feeds/${feed_file}" 2>/dev/null || true
            done
            
            # Also save the index.html
            cp /tmp/prev-index.html feeds/index.html 2>/dev/null || true
          fi
          
          # Count how many feeds were downloaded
          FEED_COUNT=$(find feeds -name "*.xml" -type f 2>/dev/null | wc -l)
          if [ "$FEED_COUNT" -gt 0 ]; then
            echo "âœ“ Downloaded $FEED_COUNT existing feed(s) from previous deployment"
          else
            echo "â„¹ No previous feeds found (this may be the first run)"
          fi
      
      - name: Transform RSS feed
        id: transform
        continue-on-error: true
        env:
          KILL_THE_NEWSLETTER_URL: ${{ secrets.KILL_THE_NEWSLETTER_URL }}
          TIMEZONE_OFFSET: ${{ vars.TIMEZONE_OFFSET }}
        run: |
          # Retry up to 3 times with linear backoff for transient failures
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            if python transform.py --output feeds --base-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" --timezone-offset $TIMEZONE_OFFSET; then
              echo "âœ“ Feed transformation succeeded"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              # Wait before retrying (linear backoff: 10s on retry 1, 20s on retry 2)
              wait_time=$((10 * attempt))
              echo "âš  Attempt failed. Waiting ${wait_time}s before retry..."
              sleep $wait_time
            fi
            attempt=$((attempt + 1))
          done
          
          echo "âœ— All attempts failed"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Check transformation result and fallback if needed
        run: |
          # Check if transformation succeeded
          if [ "${{ steps.transform.outputs.status }}" = "success" ]; then
            echo "âœ“ Using newly generated feeds"
          else
            # Check if we have feeds from a previous run
            FEED_COUNT=$(find feeds -name "*.xml" -type f 2>/dev/null | wc -l)
            if [ "$FEED_COUNT" -gt 0 ]; then
              echo "âš  Transform failed, but found $FEED_COUNT feed(s) from previous run"
              echo "â„¹ Using cached feeds from last successful deployment"
            else
              echo "âœ— Transform failed and no previous feeds available"
              exit 1
            fi
          fi
      
      - name: Create index.html for feeds
        run: |
          # Check if feeds directory exists
          if [ ! -d "feeds" ]; then
            echo "Error: feeds directory not found. Feed transformation likely failed."
            exit 1
          fi
          
          # Check if we already have an index.html from the cached deployment
          if [ -f "feeds/index.html" ] && [ "${{ steps.transform.outputs.status }}" != "success" ]; then
            echo "â„¹ Using cached index.html from previous deployment"
            exit 0
          fi
          
          # Generate the feed list from actual XML files
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          FEED_LIST=""
          for feed in feeds/*.xml; do
            if [ -f "$feed" ]; then
              filename=$(basename "$feed")
              showname=$(echo "$filename" | sed 's/.xml$//' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              FEED_LIST="${FEED_LIST}<li><a href=\"${filename}\">${showname}</a><br><small class=\"feed-url\">${BASE_URL}/${filename}</small></li>"
            fi
          done
          
          cat > feeds/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Dropout Newsletter RSS Feeds</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 800px;
                      margin: 40px auto;
                      padding: 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 {
                      color: #2563eb;
                      border-bottom: 3px solid #2563eb;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #4b5563;
                      margin-top: 30px;
                  }
                  ul {
                      list-style: none;
                      padding: 0;
                  }
                  li {
                      margin: 10px 0;
                      padding: 10px;
                      background: #f3f4f6;
                      border-radius: 5px;
                  }
                  a {
                      color: #2563eb;
                      text-decoration: none;
                      font-weight: 500;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
                  .feed-url {
                      font-family: monospace;
                      font-size: 0.9em;
                      background: #e5e7eb;
                      padding: 2px 6px;
                      border-radius: 3px;
                  }
                  .info {
                      background: #dbeafe;
                      padding: 15px;
                      border-radius: 5px;
                      border-left: 4px solid #2563eb;
                      margin: 20px 0;
                  }
              </style>
          </head>
          <body>
              <h1>ðŸ“º Dropout Newsletter RSS Feeds</h1>
              
              <div class="info">
                  <p><strong>Welcome!</strong> These RSS feeds are automatically generated from the Dropout newsletter.</p>
                  <p>Subscribe to individual shows or the combined feed using your favorite RSS reader.</p>
              </div>
              
              <h2>Available Feeds</h2>
              <ul>
                  ${FEED_LIST}
              </ul>
              
              <h2>How to Use</h2>
              <ol>
                  <li>Copy the feed URL you want to subscribe to</li>
                  <li>Open your RSS reader (e.g., Feedly, NewsBlur, NetNewsWire)</li>
                  <li>Add the feed URL to your reader</li>
                  <li>Enjoy your Dropout content!</li>
              </ol>
          </body>
          </html>
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'feeds'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
